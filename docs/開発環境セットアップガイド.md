# 開発環境セットアップガイド

## 1. 前提条件

### 1.1 必要なソフトウェア
- **Node.js**: v18以上
- **npm**: v8以上
- **Git**: 最新版
- **Cloudflare CLI (wrangler)**: v3以上
- **Shopify CLI**: 最新版（オプション）

### 1.2 アカウント準備
- **Cloudflareアカウント**: Pages、Workers、D1の利用
- **Shopifyパートナーアカウント**: アプリ開発用
- **GitHubアカウント**: コード管理用

## 2. 初期セットアップ

### 2.1 リポジトリのクローン
```bash
git clone <repository-url>
cd shopify-info-banner-app
```

### 2.2 依存関係のインストール
```bash
npm install
```

### 2.3 環境変数の設定
```bash
# .envファイルをコピー
cp .env.example .env

# 環境変数を編集
nano .env
```

### 2.4 Cloudflare CLIのセットアップ
```bash
# Wranglerのログイン
wrangler login

# アカウントIDの確認
wrangler whoami
```

## 3. Cloudflare設定

### 3.1 D1データベースの作成
```bash
# 本番用データベース
wrangler d1 create shopify-banner-db

# 開発用データベース
wrangler d1 create shopify-banner-db-dev

# ステージング用データベース
wrangler d1 create shopify-banner-db-staging
```

### 3.2 スキーマの適用
```bash
# 開発環境
wrangler d1 execute shopify-banner-db-dev --file=./workers/schema.sql

# ステージング環境
wrangler d1 execute shopify-banner-db-staging --file=./workers/schema.sql

# 本番環境
wrangler d1 execute shopify-banner-db --file=./workers/schema.sql
```

### 3.3 wrangler.tomlの設定
```bash
# データベースIDを更新
nano workers/wrangler.toml
```

## 4. Shopify設定

### 4.1 パートナーアカウントでのアプリ作成
1. [Shopify Partners](https://partners.shopify.com/)にログイン
2. 「Apps」→「Create app」をクリック
3. アプリ情報を入力：
   - App name: "Shopify Banner Manager"
   - App URL: `https://your-app-domain.com`
   - Allowed redirection URL(s): `https://your-app-domain.com/auth/callback`

### 4.2 アプリ設定の取得
- **API Key**: アプリ設定から取得
- **API Secret**: アプリ設定から取得
- **Scopes**: 必要なスコープを設定

### 4.3 開発ストアの作成
1. パートナー管理画面で「Development stores」→「Create store」
2. ストア名とURLを設定
3. 作成されたストアでアプリをテスト

## 5. 開発サーバーの起動

### 5.1 フロントエンド開発サーバー
```bash
npm run dev
```

### 5.2 Workers開発サーバー
```bash
# 別ターミナルで実行
npm run workers:dev
```

### 5.3 開発環境でのテスト
1. ブラウザで `http://localhost:3000` にアクセス
2. Shopify開発ストアでアプリをインストール
3. アプリの動作確認

## 6. テスト環境のセットアップ

### 6.1 ユニットテスト
```bash
npm run test
```

### 6.2 エンドツーエンドテスト
```bash
npm run test:e2e
```

### 6.3 リント・フォーマット
```bash
# リント実行
npm run lint

# リント修正
npm run lint:fix

# フォーマット実行
npm run format
```

## 7. デプロイ準備

### 7.1 ビルド
```bash
npm run build
```

### 7.2 ステージング環境へのデプロイ
```bash
# Workers
wrangler deploy --env staging

# Pages
wrangler pages deploy dist --project-name shopify-banner-manager-staging
```

### 7.3 本番環境へのデプロイ
```bash
# Workers
wrangler deploy

# Pages
wrangler pages deploy dist --project-name shopify-banner-manager
```

## 8. トラブルシューティング

### 8.1 よくある問題

#### CORS エラー
```bash
# wrangler.tomlのCORS設定を確認
# 開発環境ではlocalhost:3000を許可
```

#### データベース接続エラー
```bash
# データベースIDを確認
wrangler d1 list

# バインディングを確認
wrangler d1 info shopify-banner-db-dev
```

#### 認証エラー
```bash
# 環境変数の設定を確認
# Shopify API Key/Secretが正しいか確認
# リダイレクトURLが一致しているか確認
```

### 8.2 ログの確認
```bash
# Workers ログ
wrangler tail

# リアルタイムログ
wrangler tail --follow
```

## 9. 開発ワークフロー

### 9.1 ブランチ戦略
- **main**: 本番環境
- **develop**: 開発環境
- **feature/***: 機能開発
- **hotfix/***: 緊急修正

### 9.2 コミット規約
```
feat: 新機能追加
fix: バグ修正
docs: ドキュメント更新
style: コードフォーマット
refactor: リファクタリング
test: テスト追加・修正
chore: その他の変更
```

### 9.3 プルリクエスト
1. 機能ブランチからdevelopブランチへPR
2. コードレビュー
3. テスト実行
4. マージ

## 10. 参考資料

- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/)
- [Shopify App Development](https://shopify.dev/apps)
- [Polaris Design System](https://polaris.shopify.com/)
- [React Documentation](https://react.dev/)
